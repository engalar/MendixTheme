define(["../_base/lang","../Evented","../_base/declare","../_base/Deferred","../promise/all","../_base/array","../_base/connect","../regexp"],(function(t,e,n,r,o,i,a,c){function s(t){return"*"==t?".*":"?"==t?".":t}return n("dojo.data.ObjectStore",[e],{objectStore:null,constructor:function(e){this._dirtyObjects=[],e.labelAttribute&&(e.labelProperty=e.labelAttribute),t.mixin(this,e)},labelProperty:"label",getValue:function(t,e,n){return"function"==typeof t.get?t.get(e):e in t?t[e]:n},getValues:function(t,e){var n=this.getValue(t,e);return n instanceof Array?n:void 0===n?[]:[n]},getAttributes:function(t){var e=[];for(var n in t)!t.hasOwnProperty(n)||"_"==n.charAt(0)&&"_"==n.charAt(1)||e.push(n);return e},hasAttribute:function(t,e){return e in t},containsValue:function(t,e,n){return i.indexOf(this.getValues(t,e),n)>-1},isItem:function(t){return"object"==typeof t&&t&&!(t instanceof Date)},isItemLoaded:function(t){return t&&"function"!=typeof t.load},loadItem:function(t){var e;return"function"==typeof t.item.load?r.when(t.item.load(),(function(n){e=n;var r=n instanceof Error?t.onError:t.onItem;r&&r.call(t.scope,n)})):t.onItem&&t.onItem.call(t.scope,t.item),e},close:function(t){return t&&t.abort&&t.abort()},fetch:function(e){e=t.delegate(e,e&&e.queryOptions);var n=this,o=e.scope||n,a=e.query;if("object"==typeof a)for(var u in a=t.delegate(a)){var l=a[u];"string"==typeof l&&(a[u]=RegExp("^"+c.escapeString(l,"*?\\").replace(/\\.|\*|\?/g,s)+"$",e.ignoreCase?"mi":"m"),a[u].toString=function(t){return function(){return t}}(l))}var f=this.objectStore.query(a,e);function h(t){e.onError&&e.onError.call(o,t,e)}return r.when(f.total,(function(t){r.when(f,(function(n){if(e.onBegin&&e.onBegin.call(o,t||n.length,e),e.onItem)for(var r=0;r<n.length;r++)e.onItem.call(o,n[r],e);return e.onComplete&&e.onComplete.call(o,e.onItem?null:n,e),n}),h)}),h),e.abort=function(){f.cancel&&f.cancel()},f.observe&&(this.observing&&this.observing.cancel(),this.observing=f.observe((function(t,e,r){if(-1==i.indexOf(n._dirtyObjects,t))if(-1==e)n.onNew(t);else if(-1==r)n.onDelete(t);else for(var o in t)o!=n.objectStore.idProperty&&n.onSet(t,o,null,t[o])}),!0)),this.onFetch(f),e.store=this,e},getFeatures:function(){return{"dojo.data.api.Read":!!this.objectStore.get,"dojo.data.api.Identity":!0,"dojo.data.api.Write":!!this.objectStore.put,"dojo.data.api.Notification":!0}},getLabel:function(t){if(this.isItem(t))return this.getValue(t,this.labelProperty)},getLabelAttributes:function(t){return[this.labelProperty]},getIdentity:function(t){return this.objectStore.getIdentity?this.objectStore.getIdentity(t):t[this.objectStore.idProperty||"id"]},getIdentityAttributes:function(t){return[this.objectStore.idProperty]},fetchItemByIdentity:function(t){var e;return r.when(this.objectStore.get(t.identity),(function(n){e=n,t.onItem.call(t.scope,n)}),(function(e){t.onError.call(t.scope,e)})),e},newItem:function(t,e){if(e){var n=this.getValue(e.parent,e.attribute,[]);n=n.concat([t]),t.__parent=n,this.setValue(e.parent,e.attribute,n)}return this._dirtyObjects.push({object:t,save:!0}),this.onNew(t),t},deleteItem:function(t){this.changing(t,!0),this.onDelete(t)},setValue:function(t,e,n){var r=t[e];this.changing(t),t[e]=n,this.onSet(t,e,r,n)},setValues:function(e,n,r){if(!t.isArray(r))throw new Error("setValues expects to be passed an Array object as its value");this.setValue(e,n,r)},unsetAttribute:function(t,e){this.changing(t);var n=t[e];delete t[e],this.onSet(t,e,n,void 0)},changing:function(t,e){t.__isDirty=!0;for(var n=0;n<this._dirtyObjects.length;n++){var r=this._dirtyObjects[n];if(t==r.object)return void(e&&(r.object=!1,this._saveNotNeeded||(r.save=!0)))}var o=t instanceof Array?[]:{};for(n in t)t.hasOwnProperty(n)&&(o[n]=t[n]);this._dirtyObjects.push({object:!e&&t,old:o,save:!this._saveNotNeeded})},save:function(t){t=t||{};var e,n=[],r=[],i=this,c=this._dirtyObjects;c.length;try{var s;a.connect(t,"onError",(function(){if(!1!==t.revertOnError){var e=c;c=r,i.revert(),i._dirtyObjects=e}else i._dirtyObjects=c.concat(r)})),this.objectStore.transaction&&(s=this.objectStore.transaction());for(var u=0;u<c.length;u++){var l=c[u],f=l.object,h=l.old;delete f.__isDirty,f?(e=this.objectStore.put(f,{overwrite:!!h}),n.push(e)):void 0!==h&&(e=this.objectStore.remove(this.getIdentity(h)),n.push(e)),r.push(l),c.splice(u--,1)}o(n).then((function(e){t.onComplete&&t.onComplete.call(t.scope,e)}),(function(e){t.onError&&t.onError.call(t.scope,e)})),s&&s.commit()}catch(e){t.onError.call(t.scope,value)}},revert:function(){for(var t=this._dirtyObjects,e=t.length;e>0;){var n=t[--e],r=n.object,o=n.old;if(r&&o){for(var i in o)o.hasOwnProperty(i)&&r[i]!==o[i]&&(this.onSet(r,i,r[i],o[i]),r[i]=o[i]);for(i in r)o.hasOwnProperty(i)||(this.onSet(r,i,r[i]),delete r[i])}else o?this.onNew(o):this.onDelete(r);delete(r||o).__isDirty,t.splice(e,1)}},isDirty:function(t){return t?t.__isDirty:!!this._dirtyObjects.length},onSet:function(){},onNew:function(){},onDelete:function(){},onFetch:function(t){}})}));