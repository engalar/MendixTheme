define(["../_base/declare","./util/QueryResults","./util/SimpleQueryEngine"],(function(t,i,e){return t("dojo.store.Memory",null,{constructor:function(t){for(var i in t)this[i]=t[i];this.setData(this.data||[])},data:null,idProperty:"id",index:null,queryEngine:e,get:function(t){return this.data[this.index[t]]},getIdentity:function(t){return t[this.idProperty]},put:function(t,i){var e,n,r=this.data,d=this.index,s=this.idProperty,u=t[s]=i&&"id"in i?i.id:s in t?t[s]:Math.random(),a=r.length,o=u in d?"update":"add";if("update"===o){if(i&&!1===i.overwrite)throw new Error("Object already exists");a=n=d[u]}return i&&"before"in i?null==i.before?(e=r.length,"update"===o&&--e):n<(e=d[this.getIdentity(i.before)])&&--e:e=a,e===n?r[e]=t:(void 0!==n&&r.splice(n,1),r.splice(e,0,t),this._rebuildIndex(void 0===n?e:Math.min(n,e))),u},add:function(t,i){return(i=i||{}).overwrite=!1,this.put(t,i)},remove:function(t){var i=this.index,e=this.data;if(t in i)return e.splice(i[t],1),this.index={},this._rebuildIndex(),!0},query:function(t,e){return i(this.queryEngine(t,e)(this.data))},setData:function(t){t.items?(this.idProperty=t.identifier||this.idProperty,t=this.data=t.items):this.data=t,this.index={},this._rebuildIndex()},_rebuildIndex:function(t){var i,e=this.data,n=e.length;for(i=t=t||0;i<n;i++)this.index[e[i][this.idProperty]]=i}})}));