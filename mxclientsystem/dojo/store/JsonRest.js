define(["../_base/xhr","../_base/lang","../json","../_base/declare","./util/QueryResults"],(function(t,e,r,n,i){return n("dojo.store.JsonRest",null,{constructor:function(t){this.headers={},n.safeMixin(this,t)},headers:{},target:"",idProperty:"id",ascendingPrefix:"+",descendingPrefix:"-",_getTarget:function(t){var e=this.target;return void 0!==t&&("/"==e.charAt(e.length-1)||"="==e.charAt(e.length-1)?e+=t:e+="/"+t),e},get:function(r,n){n=n||{};var i=e.mixin({Accept:this.accepts},this.headers,n.headers||n);return t("GET",{url:this._getTarget(r),handleAs:"json",headers:i,timeout:n&&n.timeout})},accepts:"application/javascript, application/json",getIdentity:function(t){return t[this.idProperty]},put:function(n,i){var a="id"in(i=i||{})?i.id:this.getIdentity(n);return t(void 0===a||i.incremental?"POST":"PUT",{url:this._getTarget(a),postData:r.stringify(n),handleAs:"json",headers:e.mixin({"Content-Type":"application/json",Accept:this.accepts,"If-Match":!0===i.overwrite?"*":null,"If-None-Match":!1===i.overwrite?"*":null},this.headers,i.headers),timeout:i&&i.timeout})},add:function(t,e){return(e=e||{}).overwrite=!1,this.put(t,e)},remove:function(r,n){return n=n||{},t("DELETE",{url:this._getTarget(r),headers:e.mixin({},this.headers,n.headers),timeout:n&&n.timeout})},query:function(r,n){n=n||{};var a=e.mixin({Accept:this.accepts},this.headers,n.headers),s=this.target.indexOf("?")>-1;if((r=r||"")&&"object"==typeof r&&(r=(r=t.objectToQuery(r))?(s?"&":"?")+r:""),(n.start>=0||n.count>=0)&&(a["X-Range"]="items="+(n.start||"0")+"-"+("count"in n&&n.count!=1/0?n.count+(n.start||0)-1:""),this.rangeParam?(r+=(r||s?"&":"?")+this.rangeParam+"="+a["X-Range"],s=!0):a.Range=a["X-Range"]),n&&n.sort){var o=this.sortParam;r+=(r||s?"&":"?")+(o?o+"=":"sort(");for(var h=0;h<n.sort.length;h++){var c=n.sort[h];r+=(h>0?",":"")+(c.descending?this.descendingPrefix:this.ascendingPrefix)+encodeURIComponent(c.attribute)}o||(r+=")")}var u=t("GET",{url:this.target+(r||""),handleAs:"json",headers:a,timeout:n&&n.timeout});return u.total=u.then((function(){var t=u.ioArgs.xhr.getResponseHeader("Content-Range");return t||(t=u.ioArgs.xhr.getResponseHeader("X-Content-Range")),t&&(t=t.match(/\/(.*)/))&&+t[1]})),i(u)}})}));