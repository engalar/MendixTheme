define(["../_base/lang","../when","../_base/array"],(function(e,t,n){var r=function(r){var i,o=[],f=0;(r=e.delegate(r)).notify=function(e,t,n){f++;for(var r=o.slice(),i=0,a=r.length;i<a;i++)r[i](e,t,n)};var a,u=r.query;function c(e,n){var i=r[e];i&&(r[e]=function(o,f){var u;if("put"===e&&(u=r.getIdentity(o)),a)return i.apply(this,arguments);a=!0;try{var c=i.apply(this,arguments);return t(c,(function(e){n("object"==typeof e&&e||o,u,f)})),c}finally{a=!1}})}return r.query=function(a,c){c=c||{};var l=u.apply(this,arguments);if(l&&l.forEach){var s=e.mixin({},c);delete s.start,delete s.count;var v,y=r.queryEngine&&r.queryEngine(a,s),d=f,h=[];l.observe=function(e,a){1==h.push(e)&&o.push(v=function(e,o,u){var s=u&&u.before&&r.getIdentity(u.before);t(l,(function(t){var l,v,p,g=t.length!=c.count;if(++d!=f)throw new Error("Query is out of date, you must observe() the query prior to any data modifications");var b,m,x=-1,O=-1;if(o!==i){var q=[].concat(t);for(y&&!e&&(q=y(t)),l=0,v=t.length;l<v;l++){var I=t[l];if(r.getIdentity(I)==o){if(q.indexOf(I)<0)continue;b=I,x=l,!y&&e||t.splice(l,1);break}}}if(y){if(e&&(y.matches?y.matches(e):y([e]).length)){var E=x>-1?x:t.length;t.splice(E,0,e),O=n.indexOf(y(t),e),t.splice(E,1),c.start&&0==O||!g&&O==t.length?O=-1:(u&&void 0!==u.before&&(m=null===u.before?t.length:function(e,t,n,r,i){var o;for(r=null==r?0:r,i=null==i?t.length:i,o=r;o<i;++o)if(e.getIdentity(t[o])===n)return o;return-1}(r,t,s),-1!==m&&(O=m)),t.splice(O,0,e))}}else e&&(o!==i?O=x:c.start||(O=r.defaultIndex||0,t.splice(O,0,e)));if((x>-1||O>-1)&&(a||!y||x!=O)){var j=h.slice();for(l=0;p=j[l];l++)p(e||b,x,O)}}))});var u={};return u.remove=u.cancel=function(){var t=n.indexOf(h,e);t>-1&&(h.splice(t,1),h.length||o.splice(n.indexOf(o,v),1))},u}}return l},c("put",(function(e,t,n){r.notify(e,t,n)})),c("add",(function(e,t,n){r.notify(e,t,n)})),c("remove",(function(e){r.notify(void 0,e)})),r};return e.setObject("dojo.store.Observable",r),r}));