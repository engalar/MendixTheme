define(["../_base/lang","../_base/declare","../Deferred","../_base/array","./util/QueryResults","./util/SimpleQueryEngine"],(function(t,e,r,n,o,i){return e("dojo.store.DataStore",null,{target:"",constructor:function(e){if(t.mixin(this,e),!("idProperty"in e)){var r;try{r=this.store.getIdentityAttributes()}catch(t){}this.idProperty=(t.isArray(r)?r[0]:r)||this.idProperty}var n=this.store.getFeatures();n["dojo.data.api.Read"]||(this.get=null),n["dojo.data.api.Identity"]||(this.getIdentity=null),n["dojo.data.api.Write"]||(this.put=this.add=null)},idProperty:"id",store:null,queryEngine:i,_objectConverter:function(t){var e=this.store,r=this.idProperty;function n(t){for(var o={},i=e.getAttributes(t),u=0;u<i.length;u++){var s=i[u],a=e.getValues(t,s);if(a.length>1){for(var c=0;c<a.length;c++)"object"==typeof(l=a[c])&&e.isItem(l)&&(a[c]=n(l));l=a}else{var l;"object"==typeof(l=e.getValue(t,s))&&e.isItem(l)&&(l=n(l))}o[i[u]]=l}return!(r in o)&&e.getIdentity&&(o[r]=e.getIdentity(t)),o}return function(e){return t(e&&n(e))}},get:function(t,e){var n,o,i=new r;if(this.store.fetchItemByIdentity({identity:t,onItem:this._objectConverter((function(t){i.resolve(n=t)})),onError:function(t){i.reject(o=t)}}),void 0!==n)return null==n?void 0:n;if(o)throw o;return i.promise},put:function(t,e){var n=void 0!==(e=e||{}).id?e.id:this.getIdentity(t),o=this.store,i=this.idProperty,u=new r;if(void 0===n){var s=o.newItem(t);o.save({onComplete:function(){u.resolve(s)},onError:function(t){u.reject(t)}})}else o.fetchItemByIdentity({identity:n,onItem:function(r){if(r){if(!1===e.overwrite)return u.reject(new Error("Overwriting existing object not allowed"));for(var n in t)n!=i&&t.hasOwnProperty(n)&&o.getValue(r,n)!=t[n]&&o.setValue(r,n,t[n])}else{if(!0===e.overwrite)return u.reject(new Error("Creating new object not allowed"));r=o.newItem(t)}o.save({onComplete:function(){u.resolve(r)},onError:function(t){u.reject(t)}})},onError:function(t){u.reject(t)}});return u.promise},add:function(t,e){return(e=e||{}).overwrite=!1,this.put(t,e)},remove:function(t){var e=this.store,n=new r;return this.store.fetchItemByIdentity({identity:t,onItem:function(t){try{null==t?n.resolve(!1):(e.deleteItem(t),e.save(),n.resolve(!0))}catch(t){n.reject(t)}},onError:function(t){n.reject(t)}}),n.promise},query:function(e,i){var u,s=new r((function(){u.abort&&u.abort()}));s.total=new r;var a=this._objectConverter((function(t){return t}));return u=this.store.fetch(t.mixin({query:e,onBegin:function(t){s.total.resolve(t)},onComplete:function(t){s.resolve(n.map(t,a))},onError:function(t){s.reject(t)}},i)),o(s)},getIdentity:function(t){return t[this.idProperty]}})}));