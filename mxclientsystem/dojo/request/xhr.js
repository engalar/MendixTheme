define(["../errors/RequestError","./watch","./handlers","./util","../has"],(function(e,t,r,n,o){o.add("native-xhr",(function(){return"undefined"!=typeof XMLHttpRequest})),o.add("dojo-force-activex-xhr",(function(){return o("activex")&&"file:"===window.location.protocol})),o.add("native-xhr2",(function(){if(o("native-xhr")&&!o("dojo-force-activex-xhr")){var e=new XMLHttpRequest;return void 0!==e.addEventListener&&("undefined"==typeof opera||void 0!==e.upload)}})),o.add("native-formdata",(function(){return"undefined"!=typeof FormData})),o.add("native-blob",(function(){return"undefined"!=typeof Blob})),o.add("native-arraybuffer",(function(){return"undefined"!=typeof ArrayBuffer})),o.add("native-response-type",(function(){return o("native-xhr")&&void 0!==(new XMLHttpRequest).responseType})),o.add("native-xhr2-blob",(function(){if(o("native-response-type")){var e=new XMLHttpRequest;e.open("GET","https://dojotoolkit.org/",!0),e.responseType="blob";var t=e.responseType;return e.abort(),"blob"===t}}));var a,s,i,d,u={blob:o("native-xhr2-blob")?"blob":"arraybuffer",document:"document",arraybuffer:"arraybuffer"};function c(t,o){var a,s=t.xhr;t.status=t.xhr.status;try{t.text=s.responseText}catch(e){}if("xml"===t.options.handleAs&&(t.data=s.responseXML),o)this.reject(o);else{try{r(t)}catch(e){a=e}n.checkStatus(s.status)?a?this.reject(a):this.resolve(t):a?(o=new e("Unable to load "+t.url+" status: "+s.status+" and an error in handleAs: transformation of response",t),this.reject(o)):(o=new e("Unable to load "+t.url+" status: "+s.status,t),this.reject(o))}}function f(e){return this.xhr.getResponseHeader(e)}o("native-xhr2")?(a=function(e){return!this.isFulfilled()},d=function(e,t){t.xhr.abort()},i=function(t,r,n,o){function a(e){r.handleResponse(n)}function s(t){var o=t.target,a=new e("Unable to load "+n.url+" status: "+o.status,n);r.handleResponse(n,a)}function i(e,t){n.transferType=e,t.lengthComputable?(n.loaded=t.loaded,n.total=t.total,r.progress(n)):3===n.xhr.readyState&&(n.loaded="loaded"in t?t.loaded:t.position,r.progress(n))}function d(e){return i("download",e)}function u(e){return i("upload",e)}return t.addEventListener("load",a,!1),t.addEventListener("error",s,!1),t.addEventListener("progress",d,!1),o&&t.upload&&t.upload.addEventListener("progress",u,!1),function(){t.removeEventListener("load",a,!1),t.removeEventListener("error",s,!1),t.removeEventListener("progress",d,!1),t.upload.removeEventListener("progress",u,!1),t=null}}):(a=function(e){return e.xhr.readyState},s=function(e){return 4===e.xhr.readyState},d=function(e,t){var r=t.xhr,n=typeof r.abort;"function"!==n&&"object"!==n&&"unknown"!==n||r.abort()});var l,p={data:null,query:null,sync:!1,method:"GET"};function v(r,h,y){var b=o("native-formdata")&&h&&h.data&&h.data instanceof FormData,x=n.parseArgs(r,n.deepCreate(p,h),b);r=x.url;var w=!(h=x.options).data&&"POST"!==h.method&&"PUT"!==h.method;o("ie")<=10&&(r=r.split("#")[0]);var m,L=n.deferred(x,d,a,s,c,(function(){m&&m()})),T=x.xhr=v._create();if(!T)return L.cancel(new e("XHR was not created")),y?L:L.promise;x.getHeader=f,i&&(m=i(T,L,x,h.uploadProgress));var X=void 0===h.data?null:h.data,H=!h.sync,M=h.method;try{T.open(M,r,H,h.user||l,h.password||l),h.withCredentials&&(T.withCredentials=h.withCredentials),o("native-response-type")&&h.handleAs in u&&(T.responseType=u[h.handleAs]);var R=h.headers,j=!b&&!w&&"application/x-www-form-urlencoded";if(R)for(var g in R)"content-type"===g.toLowerCase()?j=R[g]:R[g]&&T.setRequestHeader(g,R[g]);j&&!1!==j&&T.setRequestHeader("Content-Type",j),R&&"X-Requested-With"in R||T.setRequestHeader("X-Requested-With","XMLHttpRequest"),n.notify&&n.notify.emit("send",x,L.promise.cancel),T.send(X)}catch(e){L.reject(e)}return t(L),T=null,y?L:L.promise}if(v._create=function(){throw new Error("XMLHTTP not available")},o("native-xhr")&&!o("dojo-force-activex-xhr"))v._create=function(){return new XMLHttpRequest};else if(o("activex"))try{new ActiveXObject("Msxml2.XMLHTTP"),v._create=function(){return new ActiveXObject("Msxml2.XMLHTTP")}}catch(e){try{new ActiveXObject("Microsoft.XMLHTTP"),v._create=function(){return new ActiveXObject("Microsoft.XMLHTTP")}}catch(e){}}return n.addCommonMethods(v),v}));