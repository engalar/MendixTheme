define(["module","require","./watch","./util","./handlers","../_base/lang","../io-query","../query","../has","../dom","../dom-construct","../_base/window","../NodeList-dom","../NodeList-manipulate"],(function(e,t,o,r,n,a,i,l,d,u,s,m){var c=e.id.replace(/[\/\.\-]/g,"_"),f=c+"_onload";function h(e){return!this.isFulfilled()}function _(e){return!!this._finished}function g(e,t){if(!t)try{var o=e.options,r=b.doc(b._frame),i=o.handleAs;if("html"!==i){if("xml"===i)if("html"===r.documentElement.tagName.toLowerCase()){l("a",r.documentElement).orphan();var d=r.documentElement.innerText||r.documentElement.textContent;d=d.replace(/>\s+</g,"><"),e.text=a.trim(d)}else e.data=r;else e.text=r.getElementsByTagName("textarea")[0].value;n(e)}else e.data=r}catch(e){t=e}t?this.reject(t):this._finished?this.resolve(e):this.reject(new Error("Invalid dojo/request/iframe request state"))}function p(e){this._callNext()}m.global[f]||(m.global[f]=function(){var e=b._currentDfd;if(e){var t=e.response.options,o=u.byId(t.form)||e._tmpForm;if(o){for(var r=e._contentToClean,n=0;n<r.length;n++)for(var a=r[n],i=0;i<o.childNodes.length;i++){var l=o.childNodes[i];if(l.name===a){s.destroy(l);break}}e._originalAction&&o.setAttribute("action",e._originalAction),e._originalMethod&&(o.setAttribute("method",e._originalMethod),o.method=e._originalMethod),e._originalTarget&&(o.setAttribute("target",e._originalTarget),o.target=e._originalTarget)}e._tmpForm&&(s.destroy(e._tmpForm),delete e._tmpForm),e._finished=!0}else b._fireNextRequest()});var v={method:"POST"};function b(e,t,n){var a=r.parseArgs(e,r.deepCreate(v,t),!0);if(e=a.url,"GET"!==(t=a.options).method&&"POST"!==t.method)throw new Error(t.method+" not supported by dojo/request/iframe");b._frame||(b._frame=b.create(b._iframeName,f+"();"));var i=r.deferred(a,null,h,_,g,p);return i._callNext=function(){this._calledNext||(this._calledNext=!0,b._currentDfd=null,b._fireNextRequest())},i._legacy=n,b._dfdQueue.push(i),b._fireNextRequest(),o(i),n?i:i.promise}return b.create=function(e,o,r){if(m.global[e])return m.global[e];if(m.global.frames[e])return m.global.frames[e];r||(d("config-useXDomain")&&!d("config-dojoBlankHtmlUrl")&&console.warn("dojo/request/iframe: When using cross-domain Dojo builds, please save dojo/resources/blank.html to your domain and set dojoConfig.dojoBlankHtmlUrl to the path on your domain to blank.html"),r=d("config-dojoBlankHtmlUrl")||t.toUrl("dojo/resources/blank.html"));var n=s.place('<iframe id="'+e+'" name="'+e+'" src="'+r+'" onload="'+o+'" style="position: absolute; left: 1px; top: 1px; height: 1px; width: 1px; visibility: hidden">',m.body());return m.global[e]=n,n},b.doc=function(e){if(e.contentDocument)return e.contentDocument;var t=e.name;if(t){var o=m.doc.getElementsByTagName("iframe");if(e.document&&o[t].contentWindow&&o[t].contentWindow.document)return o[t].contentWindow.document;if(m.doc.frames[t]&&m.doc.frames[t].document)return m.doc.frames[t].document}return null},b.setSrc=function(e,t,o){var r=m.global.frames[e.name];r.contentWindow&&(r=r.contentWindow);try{o?r.location.replace(t):r.location=t}catch(e){console.log("dojo/request/iframe.setSrc: ",e)}},b._iframeName=c+"_IoIframe",b._notifyStart=function(){},b._dfdQueue=[],b._currentDfd=null,b._fireNextRequest=function(){var e;try{if(b._currentDfd||!b._dfdQueue.length)return;do{e=b._currentDfd=b._dfdQueue.shift()}while(e&&(e.canceled||e.isCanceled&&e.isCanceled())&&b._dfdQueue.length);if(!e||e.canceled||e.isCanceled&&e.isCanceled())return void(b._currentDfd=null);var t,o=e.response,n=o.options,d=e._contentToClean=[],f=u.byId(n.form),h=r.notify,_=n.data||null;if(e._legacy||"POST"!==n.method||f?"GET"===n.method&&f&&o.url.indexOf("?")>-1&&(t=o.url.slice(o.url.indexOf("?")+1),_=a.mixin(i.queryToObject(t),_)):f=e._tmpForm=s.create("form",{name:c+"_form",style:{position:"absolute",top:"-1000px",left:"-1000px"}},m.body()),f){if(!e._legacy){var g=f;do{g=g.parentNode}while(g&&g!==m.doc.documentElement);g||(f.style.position="absolute",f.style.left="-1000px",f.style.top="-1000px",m.body().appendChild(f)),f.name||(f.name=c+"_form")}if(_){var p=function(e,t){s.create("input",{type:"hidden",name:e,value:t},f),d.push(e)};for(var v in _){var y=_[v];if(a.isArray(y)&&y.length>1)for(var x=0;x<y.length;x++)p(v,y[x]);else{var N=l("input[name='"+v+"']",f);-1==N.indexOf()?p(v,y):N.val(y)}}}var T=f.getAttributeNode("action"),j=f.getAttributeNode("method"),w=f.getAttributeNode("target");o.url&&(e._originalAction=T?T.value:null,T?T.value=o.url:f.setAttribute("action",o.url)),e._legacy?j&&j.value||(j?j.value=n.method:f.setAttribute("method",n.method)):(e._originalMethod=j?j.value:null,j?j.value=n.method:f.setAttribute("method",n.method)),e._originalTarget=w?w.value:null,w?w.value=b._iframeName:f.setAttribute("target",b._iframeName),f.target=b._iframeName,h&&h.emit("send",o,e.promise.cancel),b._notifyStart(o),f.submit()}else{var A="";o.options.data&&"string"!=typeof(A=o.options.data)&&(A=i.objectToQuery(A));var q=o.url+(o.url.indexOf("?")>-1?"&":"?")+A;h&&h.emit("send",o,e.promise.cancel),b._notifyStart(o),b.setSrc(b._frame,q,!0)}}catch(t){e.reject(t)}},r.addCommonMethods(b,["GET","POST"]),b}));