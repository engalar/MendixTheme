define(["../dom","../sniff","../_base/array","../_base/lang","../_base/window"],(function(n,t,e,r,i){var u=r.trim,o=e.forEach,a=function(){return i.doc},f="BackCompat"==a().compatMode,c=">~+",l=!1,s=function(){return!0},d=function(n){c.indexOf(n.slice(-1))>=0?n+=" * ":n+=" ";for(var t,e,r=function(t,e){return u(n.slice(t,e))},i=[],o=-1,a=-1,f=-1,s=-1,d=-1,g=-1,h=-1,p="",v="",m=0,y=n.length,b=null,x=null,A=function(){g>=0&&(b.id=r(g,m).replace(/\\/g,""),g=-1),function(){if(h>=0){var n=h==m?null:r(h,m);b[c.indexOf(n)<0?"tag":"oper"]=n,h=-1}}(),d>=0&&(b.classes.push(r(d+1,m).replace(/\\/g,"")),d=-1)};p=v,v=n.charAt(m),m<y;m++)if("\\"!=p)if(b||(e=m,b={query:null,pseudos:[],attrs:[],classes:[],tag:null,oper:null,id:null,getTag:function(){return l?this.otag:this.tag}},h=m),t)v==t&&(t=null);else if("'"!=v&&'"'!=v)if(o>=0){if("]"==v){x.attr?x.matchFor=r(f||o+1,m):x.attr=r(o+1,m);var O=x.matchFor;O&&('"'!=O.charAt(0)&&"'"!=O.charAt(0)||(x.matchFor=O.slice(1,-1))),x.matchFor&&(x.matchFor=x.matchFor.replace(/\\/g,"")),b.attrs.push(x),x=null,o=f=-1}else if("="==v){var N="|~^$*".indexOf(p)>=0?p:"";x.type=N+v,x.attr=r(o+1,m-N.length),f=m+1}}else a>=0?")"==v&&(s>=0&&(x.value=r(a+1,m)),s=a=-1):"#"==v?(A(),g=m+1):"."==v?(A(),d=m):":"==v?(A(),s=m):"["==v?(A(),o=m,x={}):"("==v?(s>=0&&(x={name:r(s+1,m),value:null},b.pseudos.push(x)),a=m):" "==v&&p!=v&&(A(),s>=0&&b.pseudos.push({name:r(s+1,m)}),b.loops=b.pseudos.length||b.attrs.length||b.classes.length,b.oquery=b.query=r(e,m),b.otag=b.tag=b.oper?null:b.tag||"*",b.tag&&(b.tag=b.tag.toUpperCase()),i.length&&i[i.length-1].oper&&(b.infixOper=i.pop(),b.query=b.infixOper.query+" "+b.query),i.push(b),b=null);else t=v;return i},g=function(n,t){return n?t?function(){return n.apply(window,arguments)&&t.apply(window,arguments)}:n:t},h=function(n,t){var e=t||[];return n&&e.push(n),e},p=function(n){return 1==n.nodeType},v=function(n,t){return n?"class"==t?n.className||"":"for"==t?n.htmlFor||"":"style"==t?n.style.cssText||"":(l?n.getAttribute(t):n.getAttribute(t,2))||"":""},m={"*=":function(n,t){return function(e){return v(e,n).indexOf(t)>=0}},"^=":function(n,t){return function(e){return 0==v(e,n).indexOf(t)}},"$=":function(n,t){return function(e){var r=" "+v(e,n),i=r.lastIndexOf(t);return i>-1&&i==r.length-t.length}},"~=":function(n,t){var e=" "+t+" ";return function(t){return(" "+v(t,n)+" ").indexOf(e)>=0}},"|=":function(n,t){var e=t+"-";return function(r){var i=v(r,n);return i==t||0==i.indexOf(e)}},"=":function(n,t){return function(e){return v(e,n)==t}}},y=a().documentElement,b=!(y.nextElementSibling||"nextElementSibling"in y),x=b?"nextSibling":"nextElementSibling",A=b?"previousSibling":"previousElementSibling",O=b?p:s,N=function(n){for(;n=n[A];)if(O(n))return!1;return!0},T=function(n){for(;n=n[x];)if(O(n))return!1;return!0},_=function(n){var e=n.parentNode,r=0,i=(e=7!=e.nodeType?e:e.nextSibling).children||e.childNodes,u=n._i||n.getAttribute("_i")||-1,o=e._l||(void 0!==e.getAttribute?e.getAttribute("_l"):-1);if(!i)return-1;var a=i.length;if(o==a&&u>=0&&o>=0)return u;t("ie")&&void 0!==e.setAttribute?e.setAttribute("_l",a):e._l=a,u=-1;for(var f=e.firstElementChild||e.firstChild;f;f=f[x])O(f)&&(t("ie")?f.setAttribute("_i",++r):f._i=++r,n===f&&(u=r));return u},E=function(n){return!(_(n)%2)},w=function(n){return _(n)%2},q={checked:function(n,t){return function(n){return!!("checked"in n?n.checked:n.selected)}},disabled:function(n,t){return function(n){return n.disabled}},enabled:function(n,t){return function(n){return!n.disabled}},"first-child":function(){return N},"last-child":function(){return T},"only-child":function(n,t){return function(n){return N(n)&&T(n)}},empty:function(n,t){return function(n){for(var t=n.childNodes,e=n.childNodes.length-1;e>=0;e--){var r=t[e].nodeType;if(1===r||3==r)return!1}return!0}},contains:function(n,t){var e=t.charAt(0);return'"'!=e&&"'"!=e||(t=t.slice(1,-1)),function(n){return n.innerHTML.indexOf(t)>=0}},not:function(n,t){var e=d(t)[0],r={el:1};"*"!=e.tag&&(r.tag=1),e.classes.length||(r.classes=1);var i=k(e,r);return function(n){return!i(n)}},"nth-child":function(n,t){var e=parseInt;if("odd"==t)return w;if("even"==t)return E;if(-1!=t.indexOf("n")){var r=t.split("n",2),i=r[0]?"-"==r[0]?-1:e(r[0]):1,u=r[1]?e(r[1]):0,o=0,a=-1;if(i>0?u<0?u=u%i&&i+u%i:u>0&&(u>=i&&(o=u-u%i),u%=i):i<0&&(i*=-1,u>0&&(a=u,u%=i)),i>0)return function(n){var t=_(n);return t>=o&&(a<0||t<=a)&&t%i==u};t=u}var f=e(t);return function(n){return _(n)==f}}},S=t("ie")<9||9==t("ie")&&t("quirks")?function(n){var t=n.toLowerCase();return"class"==t&&(n="className"),function(e){return l?e.getAttribute(n):e[n]||e[t]}}:function(n){return function(t){return t&&t.getAttribute&&t.hasAttribute(n)}},k=function(n,t){if(!n)return s;var e=null;return"el"in(t=t||{})||(e=g(e,p)),"tag"in t||"*"!=n.tag&&(e=g(e,(function(t){return t&&(l?t.tagName:t.tagName.toUpperCase())==n.getTag()}))),"classes"in t||o(n.classes,(function(n,t,r){var i=new RegExp("(?:^|\\s)"+n+"(?:\\s|$)");(e=g(e,(function(n){return i.test(n.className)}))).count=t})),"pseudos"in t||o(n.pseudos,(function(n){var t=n.name;q[t]&&(e=g(e,q[t](t,n.value)))})),"attrs"in t||o(n.attrs,(function(n){var t,r=n.attr;n.type&&m[n.type]?t=m[n.type](r,n.matchFor):r.length&&(t=S(r)),t&&(e=g(e,t))})),"id"in t||n.id&&(e=g(e,(function(t){return!!t&&t.id==n.id}))),e||"default"in t||(e=s),e},C=function(n,t){var r=function(n){var t=[];try{t=Array.prototype.slice.call(n)}catch(i){for(var e=0,r=n.length;e<r;e++)t.push(n[e])}return t};return n=n||s,function(i,u,o){var a,f=0,c=[];for(c=r(i.children||i.childNodes),t&&e.forEach(c,(function(n){1===n.nodeType&&(c=c.concat(r(n.getElementsByTagName("*"))))}));a=c[f++];)O(a)&&(!o||Q(a,o))&&n(a,f)&&u.push(a);return u}},F=function(n,t){for(var e=n.parentNode;e&&e!=t;)e=e.parentNode;return!!e},z={},B=function(t){var r=z[t.query];if(r)return r;var i=t.infixOper,u=i?i.oper:"",o=k(t,{el:1}),c="*"==t.tag,l=a().getElementsByClassName;if(u){var d={el:1};c&&(d.tag=1),o=k(t,d),"+"==u?r=function(n){return function(t,e,r){for(;t=t[x];)if(!b||p(t)){r&&!Q(t,r)||!n(t)||e.push(t);break}return e}}(o):"~"==u?r=function(n){return function(t,e,r){for(var i=t[x];i;){if(O(i)){if(r&&!Q(i,r))break;n(i)&&e.push(i)}i=i[x]}return e}}(o):">"==u&&(r=C(o))}else if(t.id)o=!t.loops&&c?s:k(t,{el:1,id:1}),r=function(r,i){var u=n.byId(t.id,r.ownerDocument||r);if(r.ownerDocument&&!F(r,r.ownerDocument)){var a=11===r.nodeType?r.childNodes:[r];e.some(a,(function(n){var e=C((function(n){return n.id===t.id}),!0)(n,[]);if(e.length)return u=e[0],!1}))}if(u&&o(u))return 9==r.nodeType||F(u,r)?h(u,i):void 0};else if(l&&/\{\s*\[native code\]\s*\}/.test(String(l))&&t.classes.length&&!f){o=k(t,{el:1,classes:1,id:1});var g=t.classes.join(" ");r=function(n,t,e){for(var r,i=h(0,t),u=0,a=n.getElementsByClassName(g);r=a[u++];)o(r,n)&&Q(r,e)&&i.push(r);return i}}else c||t.loops?(o=k(t,{el:1,tag:1,id:1}),r=function(n,e,r){for(var i,u=h(0,e),a=0,f=t.getTag(),c=f?n.getElementsByTagName(f):[];i=c[a++];)o(i,n)&&Q(i,r)&&u.push(i);return u}):r=function(n,e,r){for(var i,u=h(0,e),o=0,a=t.getTag(),f=a?n.getElementsByTagName(a):[];i=f[o++];)Q(i,r)&&u.push(i);return u};return z[t.query]=r},I={},D={},$=function(n){var t=d(u(n));if(1==t.length){var e=B(t[0]);return function(n){var t=e(n,[]);return t&&(t.nozip=!0),t}}return function(n){return function(n,t){for(var e,r,i,u,o=h(n),a=t.length,f=0;f<a;f++){u=[],e=t[f],o.length-1>0&&(i={},u.nozip=!0);for(var c=B(e),l=0;r=o[l];l++)c(r,u,i);if(!u.length)break;o=u}return u}(n,t)}},L=t("ie")?"commentStrip":"nozip",M="querySelectorAll",U=!!a()[M],j=/\\[>~+]|n\+\d|([^ \\])?([>~+])([^ =])?/g,H=function(n,t,e,r){return e?(t?t+" ":"")+e+(r?" "+r:""):n},R=/([^[]*)([^\]]*])?/g,G=function(n,t,e){return t.replace(j,H)+(e||"")},J=function(n,e){if(n=n.replace(R,G),U){var r=D[n];if(r&&!e)return r}var i=I[n];if(i)return i;var u=n.charAt(0),o=-1==n.indexOf(" ");if(n.indexOf("#")>=0&&o&&(e=!0),U&&!e&&-1==c.indexOf(u)&&(!t("ie")||-1==n.indexOf(":"))&&!(f&&n.indexOf(".")>=0)&&-1==n.indexOf(":contains")&&-1==n.indexOf(":checked")&&-1==n.indexOf("|=")){var a=c.indexOf(n.charAt(n.length-1))>=0?n+" *":n;return D[n]=function(t){if(9==t.nodeType||o)try{var e=t[M](a);return e[L]=!0,e}catch(n){}return J(n,!0)(t)}}var l=n.match(/([^\s,](?:"(?:\\.|[^"])+"|'(?:\\.|[^'])+'|[^,])*)/g);return I[n]=l.length<2?$(n):function(n){for(var t,e=0,r=[];t=l[e++];)r=r.concat($(t)(n));return r}},K=0,P=t("ie")?function(n){return l?n.getAttribute("_uid")||n.setAttribute("_uid",++K)||K:n.uniqueID}:function(n){return n._uid||(n._uid=++K)},Q=function(n,t){if(!t)return 1;var e=P(n);return t[e]?0:t[e]=1},V="_zipIdx",W=function(n,e){var r=(e=e||a()).ownerDocument||e;l="div"===r.createElement("div").tagName;var i=J(n)(e);return i&&i.nozip?i:function(n){if(n&&n.nozip)return n;if(!n||!n.length)return[];if(n.length<2)return[n[0]];var e,r,i=[];if(K++,t("ie")&&l){var u=K+"";for(e=0;e<n.length;e++)(r=n[e])&&r.getAttribute(V)!=u&&(i.push(r),r.setAttribute(V,u))}else if(t("ie")&&n.commentStrip)try{for(e=0;e<n.length;e++)(r=n[e])&&p(r)&&i.push(r)}catch(n){}else for(e=0;e<n.length;e++)(r=n[e])&&r[V]!=K&&(i.push(r),r[V]=K);return i}(i)};return W.filter=function(t,r,i){for(var u,o=[],a=d(r),f=1!=a.length||/[^\w#\.]/.test(r)?function(t){return-1!=e.indexOf(W(r,n.byId(i)),t)}:k(a[0]),c=0;u=t[c];c++)f(u)&&o.push(u);return o},W}));